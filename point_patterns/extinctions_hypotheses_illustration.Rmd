---
title: "Spatial scaling of extinction rates, and it's link to biological processes"
author: "Petr Keil, Vojtech Bartak, Francois Leroy"
date: "2023-06-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Settings and Libraries

```{r, warning = FALSE, message = FALSE}
library(mobsim) # simulating point pattern communities
library(manipulate) # sliders and interactive plotting
library(randomForest) # random forest

# graphics
library(tidyverse)
library(gridExtra) # multiple ggplots in a figure
library(latex2exp) # for math symbols in figures

# parallel computation
library(foreach)
library(doParallel)

# our own functions
source("extinctions_functions.r")

# setting the random seed
set.seed(12345)
```

# Histograms illustrating different SADs

```{r, fig.width=10}
dat <- SAD.prob.mass(1000, 100, cv_abund.vect = c(10))

SAD10 <- ggplot(data = dat, aes(x=N, y = PM)) +
          geom_point() +
          geom_line() +
          theme_classic() + 
          ylim(0, 0.2) + ylab("Probablity mass") + 
          xlab("Species abundance (# of individuals)") +
          labs(title= "(a)") 
          
SAD10

N = 100
S = 10
cv.abund = 1
sigma = 0.1
alpha = 0.9
beta = -1
side.divisions = c(2,4,8,16)
set.seed(1234)

eff1 <- data.frame(N = seq(1,40), 
                   P.death = effect.f(alpha, beta, N = seq(1,40), plot=FALSE))
eff1.plot <- ggplot(data = eff1, aes(x = N, y = P.death)) + 
        geom_point() +
        geom_line() +
        ylim(0,1) + 
        ylab(expression(P[death])) +
        theme_classic() + 
        xlab("Species abundance (# of individuals)") +
        labs(title= "(b)") 

  com <- sim_thomas_community(n_sim  = N,
                              s_pool = S,
                              sad_coef = list(cv_abund = cv.abund),
                              mother_points = 1,
                              sigma  = sigma)

  # Species-Abundance Distribution - SAD
  SAD <- data.frame(table(com$census$species))
  names(SAD) <- c("species", "N.tot")
  SAD$species <- as.character(SAD$species)
  census <- left_join(com$census, SAD, by="species")
  
  # re-scale P.minus
  P.minus.vect <- effect.f(alpha, beta, N = census$N.tot, plot = FALSE)
  
  # sample individuals that will be killed
  deaths <- rbinom(n = length(P.minus.vect), size = 1, prob = P.minus.vect)
  dead.coords <- com$census[deaths == 1, ]
  
  ef <- effect.f(alpha, beta, plot = TRUE)
  
  deltas <- com.extinction(com, 
                           side.divisions, 
                           alpha = alpha, 
                           beta = beta,
                           plot.res = TRUE)


# ------------------------------------------------------------------------------  
# plot just the points
  ggplot(data = com$census, aes(x = x, y = y)) +
      geom_point(aes(colour = species)) +
    theme_minimal() + 
     #geom_point(data = dead.coords, shape = 4, size = 2.5) +
        coord_fixed(ratio = 1) +
        scale_x_continuous(breaks = seq(0, 1, by = 1/grains[i])) + 
        scale_y_continuous(breaks = seq(0, 1, by = 1/grains[i])) + 
        theme(axis.text.x=element_blank(),
              legend.position = "none",
              panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              axis.text.y=element_blank(),
              axis.title.x=element_blank(), axis.title.y=element_blank()) +
        labs(title= my.labs[i]) 
  
  
  
# ------------------------------------------------------------------------------  
  figs <- list()
  grains <- c(16,8,4,2)
  my.labs <- c("(c)"," ", " ", " ")
  for(i in 1:length(grains))
  {
    figs[[i]] <-  ggplot(data = com$census, aes(x = x, y = y)) +
      geom_point(aes(colour = species)) + 
      geom_point(data = dead.coords, shape = 4, size = 2.5) +
      theme_minimal() + 
        coord_fixed(ratio = 1) +
        scale_x_continuous(breaks = seq(0, 1, by = 1/grains[i])) + 
        scale_y_continuous(breaks = seq(0, 1, by = 1/grains[i])) + 
        theme(axis.text.x=element_blank(),
              legend.position = "none",
              axis.text.y=element_blank(),
              panel.grid.major = element_line(color = "darkgrey"),
              panel.grid.minor = element_blank(),
              axis.title.x=element_blank(), axis.title.y=element_blank()) +
        labs(title= my.labs[i]) 
  }
  
  grid.arrange(figs[[1]], figs[[2]], figs[[3]], figs[[4]], nrow = 1)

    
 ExAR<- ggplot(data = deltas, aes(x = A, y = E.x)) + 
    geom_point() +
    scale_x_continuous(trans='log10') +
    geom_smooth(method = lm, se = FALSE, colour = "black", size = 0.5) +
    ylim(c(0,1.5)) + 
    theme_classic() +
    xlab("Area") +
    ylab("E") +
    labs(title= "(d)")

   
 PxAR <- ggplot(data = deltas, aes(x = A, y = P.x)) + 
    geom_point() +
    scale_x_continuous(trans='log10') +
    geom_smooth(method = lm, se = FALSE, colour = "black", size = 0.5) +
    ylim(c(0,1)) + 
    theme_classic() +
    xlab("Area") +
    ylab("Px") +
    labs(title= "(e)") 

  
  
  lay.mat <- matrix(c(1,1,2,2,
                      3,4,5,6,
                      7,7,8,8), 
                    nrow = 3, ncol=4, byrow=TRUE)
  
    grid.arrange(SAD10, eff1.plot,
               figs[[1]], figs[[2]], figs[[3]], figs[[4]],
               ExAR, PxAR, layout_matrix = lay.mat)
  
pdf("JC.pdf")  
  grid.arrange(SAD10, eff1.plot,
               figs[[1]], figs[[2]], figs[[3]], figs[[4]],
               ExAR, PxAR, layout_matrix = lay.mat)
dev.off()
```


# Hypothesis 3

```{r}

  A = 1:100
  z1 = 0.05
  z2 = 0.1
  z3 = 0.25
  exz = -0.1
  c=3
  S1 = c*A^z1
  S2 = c*A^z2
  S3 = c*A^z3

  # CURVE 1 - shallow power law
  Px = (c*A^exz)/max(c*A^exz)*0.5
  Ex1 = S1*Px
  Ex2 = S2*Px
  Ex3 = S3*Px
  
  dat <- data.frame(A = rep(A, times = 3), 
                    S = c(S1, S2, S3),
                    Px = rep(Px, times = 3),
                    Ex = c(Ex1, Ex2, Ex3),
                    scenario = rep(c("i","ii","iii"), each = length(A)))
  
  SAR <- ggplot(data = dat, aes(x = A, y = S)) + 
    geom_line(aes(linetype = scenario)) + 
    labs(title = "SAR") +
    scale_x_continuous(trans='log10') +
    scale_y_continuous(trans='log10') +
    theme_classic()  +
    theme(legend.position="none")
  
  PxAR <- ggplot(data = data.frame(A, Px), aes(x = A, y = Px)) + 
    geom_line() + 
    scale_x_continuous(trans='log10') +
    labs(title = "PxAR") +
    theme_classic()  +
    theme(legend.position="none")
  
  ExAR <- ggplot(data = dat, aes(x = A, y = Ex)) + 
    geom_line(aes(linetype = scenario)) + 
    scale_x_continuous(trans='log10') +
    labs(title = "ExAR") +
    ylab(expression(E[x]==S%*%P[x])) +
    theme_classic() +
    theme(legend.position="none")
pdf("Figure_SAR.pdf", width=6, height=2.3)    
  grid.arrange(SAR, PxAR, ExAR, nrow = 1)
dev.off()
  
```
  





